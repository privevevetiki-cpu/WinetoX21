-- LocalScript в StarterGui (полный рабочий скрипт)
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- УДАЛЕНИЕ ПРЕДЫДУЩЕГО GUI, если уже есть
local oldGui = player:WaitForChild("PlayerGui"):FindFirstChild("LuaGUI")
if oldGui then oldGui:Destroy() end

-- === GUI ===
local gui = Instance.new("ScreenGui")
gui.Name = "LuaGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- === ИКОНКА ===
local iconSize = 60
local icon = Instance.new("Frame")
icon.Size = UDim2.new(0, iconSize, 0, iconSize)
icon.Position = UDim2.new(0.1, 0, 0.8, 0)
icon.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
icon.BackgroundTransparency = 0.4
icon.BorderSizePixel = 0
icon.Parent = gui

local iconCorner = Instance.new("UICorner")
iconCorner.CornerRadius = UDim.new(1, 0)
iconCorner.Parent = icon

local iconStroke = Instance.new("UIStroke")
iconStroke.Thickness = 2
iconStroke.Transparency = 0.5
iconStroke.Color = Color3.fromRGB(255, 255, 255)
iconStroke.Parent = icon

local iconText = Instance.new("TextLabel")
iconText.Size = UDim2.new(1, 0, 1, 0)
iconText.BackgroundTransparency = 1
iconText.Text = "PvP 0.4.3"
iconText.TextScaled = true
iconText.Font = Enum.Font.Arcade
iconText.TextColor3 = Color3.fromRGB(255, 255, 255)
iconText.Parent = icon

-- === ОКНО ===
local window = Instance.new("Frame")
window.Size = UDim2.new(0, 230, 0, 300)
window.Position = UDim2.new(0.5, 0, 0.5, 0)
window.AnchorPoint = Vector2.new(0.5, 0.5)
window.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
window.BackgroundTransparency = 0.15
window.Visible = false
window.Parent = gui

local winCorner = Instance.new("UICorner")
winCorner.CornerRadius = UDim.new(0.05, 0)
winCorner.Parent = window

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0,0,0,0)
title.BackgroundTransparency = 1
title.Text = "PvP Menu"
title.Font = Enum.Font.Arcade
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Parent = window

-- Контейнер для кнопок
local buttonsFrame = Instance.new("Frame")
buttonsFrame.Size = UDim2.new(1, 0, 1, -40)
buttonsFrame.Position = UDim2.new(0, 0, 0, 40)
buttonsFrame.BackgroundTransparency = 1
buttonsFrame.Parent = window

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 6)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Top
layout.Parent = buttonsFrame

-- === Вспомогательные таблицы ===
local buttons = {}        -- кнопки (TextButton)
local bindBoxes = {}      -- TextBox для биндов (только Big Ragdoll и Near Player)
local binds = {           -- хранение биндов (строка)
    ["Big Ragdoll"] = "",
    ["Near Player"] = ""
}

-- создать строку: кнопка + bind box (если нужно)
local function makeButtonRow(name, showBind)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(0.95, 0, 0, 28)
    row.BackgroundTransparency = 1
    row.Parent = buttonsFrame

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.74, 0, 1, 0)
    btn.Position = UDim2.new(0, 0, 0, 0)
    btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    btn.AutoButtonColor = false
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextScaled = true
    btn.Font = Enum.Font.Arcade
    btn.Text = name
    btn.Parent = row

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.18,0)
    corner.Parent = btn

    local bindBox = nil
    if showBind then
        bindBox = Instance.new("TextBox")
        bindBox.Size = UDim2.new(0.24, 0, 1, 0)
        bindBox.Position = UDim2.new(0.76, 0, 0, 0)
        bindBox.BackgroundColor3 = Color3.fromRGB(35,35,35)
        bindBox.TextColor3 = Color3.fromRGB(255,255,255)
        bindBox.ClearTextOnFocus = true
        bindBox.PlaceholderText = "Bind"
        bindBox.Font = Enum.Font.Arcade
        bindBox.TextScaled = true
        bindBox.Text = binds[name] or ""
        bindBox.Parent = row

        local bcorner = Instance.new("UICorner")
        bcorner.CornerRadius = UDim.new(0.18,0)
        bcorner.Parent = bindBox
    else
        -- пустая заплатка чтобы layout не ломался
        local spacer = Instance.new("Frame")
        spacer.Size = UDim2.new(0.24, 0, 1, 0)
        spacer.BackgroundTransparency = 1
        spacer.Position = UDim2.new(0.76, 0, 0, 0)
        spacer.Parent = row
    end

    return btn, bindBox
end

local buttonNames = {
    "HitBox Visible",
    "Speed Booster",
    "Big Ragdoll",
    "Near Player",
    "Button 5",
    "Button 6",
    "Button 7",
    "Button 8",
    "Button 9"
}

for _, name in ipairs(buttonNames) do
    local showBind = (name == "Big Ragdoll" or name == "Near Player")
    local btn, tb = makeButtonRow(name, showBind)
    buttons[name] = btn
    if tb then bindBoxes[name] = tb end
end

-- helper: визуализация статуса кнопки (зелёный = включено)
local function setButtonActiveVisual(name, on)
    local b = buttons[name]
    if not b then return end
    if on then
        b.BackgroundColor3 = Color3.fromRGB(0,170,0)
    else
        b.BackgroundColor3 = Color3.fromRGB(40,40,40)
    end
end

-- === HITBOX Visible (Highlight + Billboard) ===
do
    local PlayersSvc = Players
    local Local = player
    local hitboxVisible = false

    local function createHitboxESP(char, ply)
        local hitbox = char:FindFirstChild("__HITBOX")
        if hitbox and hitbox:IsA("BasePart") then
            if not hitbox:FindFirstChild("HitboxHighlight") then
                local hl = Instance.new("Highlight")
                hl.Name = "HitboxHighlight"
                hl.Adornee = hitbox
                hl.FillColor = Color3.fromRGB(0,0,0)
                hl.OutlineColor = Color3.fromRGB(255,255,255)
                hl.FillTransparency = 0.5
                hl.OutlineTransparency = 0
                hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                hl.Parent = hitbox
            end
            hitbox.Transparency = 0.5
            hitbox.CanCollide = false

            if not hitbox:FindFirstChild("HitboxNameBillboard") then
                local billboard = Instance.new("BillboardGui")
                billboard.Name = "HitboxNameBillboard"
                billboard.Adornee = hitbox
                billboard.AlwaysOnTop = true
                billboard.Size = UDim2.new(0, 120, 0, 20)
                billboard.StudsOffset = Vector3.new(0, 2.5, 0)
                billboard.Parent = hitbox

                local nameLabel = Instance.new("TextLabel")
                nameLabel.Size = UDim2.new(1, 0, 1, 0)
                nameLabel.BackgroundTransparency = 0.4
                nameLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
                nameLabel.Text = ply.DisplayName or ply.Name
                nameLabel.Font = Enum.Font.Arcade
                nameLabel.TextSize = 14
                nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                nameLabel.TextStrokeTransparency = 0.2
                nameLabel.Parent = billboard
            end
        end
    end

    local function removeHitboxESP(char)
        if not char then return end
        local hitbox = char:FindFirstChild("__HITBOX")
        if hitbox then
            local hl = hitbox:FindFirstChild("HitboxHighlight")
            if hl then hl:Destroy() end
            local bb = hitbox:FindFirstChild("HitboxNameBillboard")
            if bb then bb:Destroy() end
        end
    end

    local function updateHitboxes()
        for _, plr in ipairs(PlayersSvc:GetPlayers()) do
            if plr ~= Local and plr.Character then
                local hitbox = plr.Character:FindFirstChild("__HITBOX")
                if hitbox then
                    if hitboxVisible then
                        createHitboxESP(plr.Character, plr)
                    else
                        removeHitboxESP(plr.Character)
                    end
                end
            end
        end
    end

    local toggleBtn = buttons["HitBox Visible"]
    toggleBtn.MouseButton1Click:Connect(function()
        hitboxVisible = not hitboxVisible
        updateHitboxes()
        setButtonActiveVisual("HitBox Visible", hitboxVisible)
    end)
    setButtonActiveVisual("HitBox Visible", false)

    PlayersSvc.PlayerAdded:Connect(function(plr)
        plr.CharacterAdded:Connect(function()
            task.wait(0.5)
            updateHitboxes()
        end)
    end)
end

-- === Speed Booster ===
do
    local speedBtn = buttons["Speed Booster"]
    local speedActive = false
    local speedConn = nil
    local baseSpeed = 27

    local function getChar()
        return player.Character
    end

    local function startSpeed()
        if speedConn then return end
        speedConn = RunService.Heartbeat:Connect(function()
            local char = getChar()
            if not char then return end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local hum = char:FindFirstChildOfClass("Humanoid")
            if not hrp or not hum then return end
            local move = hum.MoveDirection
            if move.Magnitude > 0.1 then
                hrp.AssemblyLinearVelocity = Vector3.new(move.Unit.X*baseSpeed, hrp.AssemblyLinearVelocity.Y, move.Unit.Z*baseSpeed)
            else
                hrp.AssemblyLinearVelocity = Vector3.new(0, hrp.AssemblyLinearVelocity.Y, 0)
            end
        end)
    end

    local function stopSpeed()
        if speedConn then speedConn:Disconnect() speedConn = nil end
        local char = getChar()
        if char and char:FindFirstChild("HumanoidRootPart") then
            local hrp = char.HumanoidRootPart
            hrp.AssemblyLinearVelocity = Vector3.new(0, hrp.AssemblyLinearVelocity.Y, 0)
        end
    end

    speedBtn.MouseButton1Click:Connect(function()
        speedActive = not speedActive
        if speedActive then
            startSpeed()
        else
            stopSpeed()
        end
        setButtonActiveVisual("Speed Booster", speedActive)
    end)
    setButtonActiveVisual("Speed Booster", false)
end

-- === Перетаскивание окна (таскается за любую часть окна) ===
do
    local dragging = false
    local dragStart = Vector2.new()
    local startPos = window.Position

    window.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = window.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            window.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- === Big Ragdoll логика ===
local bigEnabled = false
local bigBtn = buttons["Big Ragdoll"]

local function performRagdollHit()
    local character = player.Character
    if not character then return end
    local backpack = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack")
    local bat = backpack:FindFirstChild("Bat") or character:FindFirstChild("Bat")
    local glitch = backpack:FindFirstChild("Glitched Slap") or character:FindFirstChild("Glitched Slap")
    if not bat or not glitch then return end

    if bat.Parent == character then
        bat.Parent = backpack
    end
    glitch.Parent = character

    if glitch:FindFirstChild("Activate") then
        glitch.Activate:Fire()
    else
        pcall(function() glitch:Activate() end)
    end

    task.delay(0.001, function()
        if glitch.Parent == character then
            glitch.Parent = backpack
        end
        if bat.Parent ~= character then
            bat.Parent = character
        end
    end)
end

bigBtn.MouseButton1Click:Connect(function()
    bigEnabled = not bigEnabled
    setButtonActiveVisual("Big Ragdoll", bigEnabled)
end)

-- Клик мыши: если bigEnabled и Near Player не подавляет — делаем performRagdollHit
local function isNearPlayerSuppressing()
    local nearActive = (buttons["Near Player"] and (buttons["Near Player"].BackgroundColor3 == Color3.fromRGB(0,170,0)))
    if not nearActive then return false end
    -- проверяем цель перед игроком в 10 студий (угол ±45°)
    local char = player.Character
    if not char then return false end
    local head = char:FindFirstChild("Head")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not head or not hrp then return false end
    local origin = hrp.Position
    local look = head.CFrame.LookVector
    for _, pl in pairs(Players:GetPlayers()) do
        if pl ~= player and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = pl.Character.HumanoidRootPart.Position
            local toTarget = targetPos - origin
            if toTarget.Magnitude <= 10 then
                local angle = math.acos(math.clamp(look:Dot(toTarget.Unit), -1, 1))
                if angle <= math.rad(45) then
                    return true
                end
            end
        end
    end
    return false
end

local mouse = player:GetMouse()
mouse.Button1Down:Connect(function()
    if bigEnabled and not isNearPlayerSuppressing() then
        performRagdollHit()
    end
end)

-- === Near Player (по линии взгляда, 1 удар/сек) ===
local nearEnabled = false
local nearBtn = buttons["Near Player"]
local lastNearHit = 0

local function hitNearby(plr)
    local now = tick()
    if now - lastNearHit < 1 then return end
    lastNearHit = now

    local character = player.Character
    if not character or not plr.Character then return end
    local backpack = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack")
    local bat = backpack:FindFirstChild("Bat") or character:FindFirstChild("Bat")
    local glitch = backpack:FindFirstChild("Glitched Slap") or character:FindFirstChild("Glitched Slap")
    if not bat or not glitch then return end

    if bat.Parent == character then
        bat.Parent = backpack
    end
    glitch.Parent = character

    if glitch:FindFirstChild("Activate") then
        glitch.Activate:Fire()
    else
        pcall(function() glitch:Activate() end)
    end

    task.delay(0.001, function()
        if glitch.Parent == character then
            glitch.Parent = backpack
        end
        if bat.Parent ~= character then
            bat.Parent = character
        end
    end)
end

nearBtn.MouseButton1Click:Connect(function()
    nearEnabled = not nearEnabled
    setButtonActiveVisual("Near Player", nearEnabled)
end)

-- Heartbeat: проверяем игроков в поле зрения (10 studs, ±45°)
RunService.Heartbeat:Connect(function()
    if not nearEnabled then return end
    local char = player.Character
    if not char then return end
    local head = char:FindFirstChild("Head")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not head or not hrp then return end
    local origin = hrp.Position
    local lookDir = head.CFrame.LookVector

    for _, pl in pairs(Players:GetPlayers()) do
        if pl ~= player and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = pl.Character.HumanoidRootPart.Position
            local toTarget = targetPos - origin
            if toTarget.Magnitude <= 10 then
                local angle = math.acos(math.clamp(lookDir:Dot(toTarget.Unit), -1, 1))
                if angle <= math.rad(45) then
                    hitNearby(pl)
                end
            end
        end
    end
end)

-- === BIND handling (TextBoxes + Enter to set / key toggles) ===
do
    local typing = false
    local activeTextBox = nil

    local function normalizeBindText(s)
        if not s then return "" end
        s = tostring(s):gsub("^%s*(.-)%s*$", "%1") -- trim
        return s:upper()
    end

    -- Setup TextBoxes behavior
    for name, tb in pairs(bindBoxes) do
        tb.FocusLost:Connect(function(enterPressed)
            typing = false
            activeTextBox = nil
            if enterPressed then
                local txt = normalizeBindText(tb.Text)
                -- accept empty to clear
                binds[name] = txt
                tb.Text = txt
            else
                tb.Text = binds[name] or ""
            end
        end)
        tb.Focused:Connect(function()
            typing = true
            activeTextBox = tb
            tb.Text = ""
        end)
    end

    -- InputBegan for toggling binds (only when not typing)
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if typing then return end
        -- only handle keyboard keys
        if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
        local keyName = tostring(input.KeyCode):gsub("Enum.KeyCode.", ""):upper()

        for actionName, bindStr in pairs(binds) do
            if bindStr and bindStr ~= "" then
                -- compare normalized forms
                local norm = normalizeBindText(bindStr)
                if norm == keyName or norm == keyName:sub(1, #norm) then
                    -- toggle corresponding action
                    if actionName == "Big Ragdoll" then
                        bigEnabled = not bigEnabled
                        setButtonActiveVisual("Big Ragdoll", bigEnabled)
                    elseif actionName == "Near Player" then
                        nearEnabled = not nearEnabled
                        setButtonActiveVisual("Near Player", nearEnabled)
                    end
                end
            end
        end
    end)
end

-- === Инициализация визуалок (везде нейтральный цвет, активные будут зелёными) ===
for name, btn in pairs(buttons) do
    btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
end
setButtonActiveVisual("HitBox Visible", false)
setButtonActiveVisual("Speed Booster", false)
setButtonActiveVisual("Big Ragdoll", false)
setButtonActiveVisual("Near Player", false)

-- === Иконка и открытие окна ===
icon.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        -- toggle window visibility
        if window.Visible then
            window:TweenSizeAndPosition(UDim2.new(0,0,0,0), window.Position, Enum.EasingDirection.In, Enum.EasingStyle.Quint, 0.18, true)
            task.wait(0.18)
            window.Visible = false
        else
            window.Visible = true
            window.Size = UDim2.new(0,0,0,0)
            window:TweenSizeAndPosition(UDim2.new(0,230,0,300), UDim2.new(0.5,0,0.5,0), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.22, true)
        end
    end
end)

-- RightShift toggle also works
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.RightShift then
        if window.Visible then
            window:TweenSizeAndPosition(UDim2.new(0,0,0,0), window.Position, Enum.EasingDirection.In, Enum.EasingStyle.Quint, 0.18, true)
            task.wait(0.18)
            window.Visible = false
        else
            window.Visible = true
            window.Size = UDim2.new(0,0,0,0)
            window:TweenSizeAndPosition(UDim2.new(0,230,0,300), UDim2.new(0.5,0,0.5,0), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.22, true)
        end
    end
end)
